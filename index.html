<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- No-Cache Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Stay Dry HCMC</title>
    
    <!-- SOCIAL TAGS -->
    <meta property="og:title" content="Stay Dry HCMC">
    <meta property="og:description" content="Real-time flood and weather monitoring for Ho Chi Minh City.">
    <meta property="og:image" content="https://stay-dry-hcmc.vercel.app/logo.png">
    <meta property="og:type" content="website">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f7fee7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/logo.png">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        #map { min-height: 500px; height: 100%; width: 100%; z-index: 1; }
        body { overscroll-behavior-y: none; }
        .crosshair-active { cursor: crosshair !important; }
        .crosshair-active .leaflet-interactive { cursor: crosshair !important; }
    </style>
</head>
<body class="bg-lime-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- REACT APP STARTS HERE ---
        const { useState, useEffect, useRef } = React;

        // Icon Wrapper
        const Icon = ({ name, size = 24, className, ...props }) => {
            const iconName = name;
            const iconData = window.lucide && window.lucide.icons ? window.lucide.icons[iconName] : null;
            if (!iconData) return null;
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                    dangerouslySetInnerHTML={{ __html: iconData.map(child => `<${child[0]} ${Object.entries(child[1]).map(([k, v]) => `${k}="${v}"`).join(' ')} />`).join('') }}
                />
            );
        };

        // Constants
        const HCMC_CENTER = [10.7769, 106.7009];
        const HCMC_BOUNDS = [[10.3500, 106.3000], [11.1600, 107.0200]];
        const TIDE_STATION_COORDS = { lat: 10.34, lng: 107.08 }; // Vung Tau

        const FLOOD_HOTSPOTS = [
            { name: "Nguyen Huu Canh", lat: 10.7925, lng: 106.7163, desc: "Severe flooding risk" },
            { name: "Thao Dien", lat: 10.8033, lng: 106.7329, desc: "High tide risk" },
            { name: "Huynh Tan Phat", lat: 10.7431, lng: 106.7336, desc: "Tidal flooding" },
            { name: "Tran Xuan Soan", lat: 10.7533, lng: 106.7029, desc: "Canal overflow" },
            { name: "Le Van Luong", lat: 10.7167, lng: 106.6978, desc: "Low-lying" }
        ];

        const THEMES = {
            dark: {
                bg: 'bg-slate-950', textMain: 'text-slate-100', textSub: 'text-slate-400',
                cardBg: 'bg-slate-900', cardBorder: 'border-slate-800', inputBg: 'bg-slate-800', inputBorder: 'border-slate-700',
                accentPrimary: 'text-blue-400', buttonPrimary: 'bg-blue-600 hover:bg-blue-700 text-white',
                buttonSecondary: 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-750',
                highlight: 'bg-blue-900/30 text-blue-300 border-blue-800/50',
                mapFilter: 'brightness(0.8) contrast(1.2)'
            },
            light: {
                bg: 'bg-lime-50', textMain: 'text-stone-800', textSub: 'text-stone-500',
                cardBg: 'bg-white', cardBorder: 'border-lime-100', inputBg: 'bg-stone-50', inputBorder: 'border-stone-200',
                accentPrimary: 'text-lime-700', buttonPrimary: 'bg-lime-700 hover:bg-lime-800 text-white',
                buttonSecondary: 'bg-white border-lime-200 text-lime-700 hover:bg-lime-50',
                highlight: 'bg-lime-100 text-lime-800 border-lime-200',
                mapFilter: 'none'
            }
        };

        function App() {
            const [address, setAddress] = useState('');
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [data, setData] = useState(null);
            const [mapInstance, setMapInstance] = useState(null);
            const [isPinMode, setIsPinMode] = useState(false);
            const [currentTime, setCurrentTime] = useState('');
            
            const theme = isDarkMode ? THEMES.dark : THEMES.light;
            const mapRef = useRef(null);
            const markerRef = useRef(null);
            const circleRef = useRef(null);

            // Clock
            useEffect(() => {
                const updateTime = () => {
                    const now = new Date();
                    const options = { timeZone: 'Asia/Ho_Chi_Minh', weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
                    setCurrentTime(now.toLocaleString('en-US', options));
                };
                updateTime();
                setInterval(updateTime, 60000);
            }, []);

            // Register Service Worker
            useEffect(() => {
                if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
                    navigator.serviceWorker.register('/service-worker.js').catch(console.error);
                }
            }, []);

            // Status Colors
            const getStatusColor = (value, type) => {
                if (isDarkMode) return 'text-slate-100';
                const SAFE = 'text-lime-600', WARN = 'text-orange-500', DANGER = 'text-red-600';
                switch (type) {
                    case 'rain': return value > 30 ? DANGER : value > 5 ? WARN : SAFE;
                    case 'aqi': return value > 150 ? DANGER : value > 100 ? WARN : SAFE;
                    case 'uv': return value > 8 ? DANGER : value > 5 ? WARN : SAFE;
                    case 'tide': return parseFloat(value) > 3.5 ? DANGER : parseFloat(value) > 2.5 ? WARN : SAFE;
                    case 'temp': return value > 35 ? DANGER : SAFE;
                    case 'humidity': return value > 90 ? DANGER : value > 75 ? WARN : SAFE;
                    case 'canal': return value > 2.0 ? DANGER : value > 1.5 ? WARN : SAFE;
                    default: return theme.textMain;
                }
            };

            // Init Map
            useEffect(() => {
                if (!window.L || mapInstance) return;
                try {
                    const map = window.L.map(mapRef.current, { center: HCMC_CENTER, zoom: 11, minZoom: 10, maxBounds: HCMC_BOUNDS, maxBoundsViscosity: 1.0 });
                    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
                    
                    FLOOD_HOTSPOTS.forEach(spot => {
                        const marker = window.L.circleMarker([spot.lat, spot.lng], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 8 }).addTo(map);
                        marker.bindPopup(`<b>${spot.name}</b><br>${spot.desc}`);
                    });

                    setTimeout(() => map.invalidateSize(), 500);
                    setMapInstance(map);
                } catch (err) { console.error(err); }
            }, []);

            // Map Pin Mode
            useEffect(() => {
                if (!mapInstance) return;
                const container = mapInstance.getContainer();
                if (isPinMode) {
                    container.classList.add('crosshair-active');
                    container.style.cursor = 'crosshair';
                } else {
                    container.classList.remove('crosshair-active');
                    container.style.cursor = '';
                }

                const onMapClick = async (e) => {
                    if (!isPinMode) return;
                    setIsPinMode(false); setLoading(true); setError(null);
                    const { lat, lng } = e.latlng;
                    
                    if (lat < HCMC_BOUNDS[0][0] || lat > HCMC_BOUNDS[1][0] || lng < HCMC_BOUNDS[0][1] || lng > HCMC_BOUNDS[1][1]) {
                        setError("Location outside Ho Chi Minh City."); setLoading(false); return;
                    }

                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
                        const data = await res.json();
                        await fetchEnvironmentalData(lat, lng, formatAddress(data.address));
                    } catch (err) { setError("Failed to retrieve data."); setLoading(false); }
                };

                mapInstance.on('click', onMapClick);
                return () => mapInstance.off('click', onMapClick);
            }, [mapInstance, isPinMode]);

            const formatAddress = (addrObj) => {
                if (!addrObj) return "Unknown Location";
                const parts = new Set();
                if (addrObj.road) parts.add(addrObj.road);
                let ward = addrObj.ward || addrObj.quarter || "";
                if (ward) { if (!ward.toLowerCase().includes('phường')) ward = `Phường ${ward}`; parts.add(ward); }
                if (addrObj.city_district || addrObj.district) parts.add(addrObj.city_district || addrObj.district);
                const res = Array.from(parts);
                return res.length > 0 ? res.join(', ') : (addrObj.city || "Ho Chi Minh City");
            };

            const fetchEnvironmentalData = async (lat, lng, formattedAddress) => {
                try {
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,weather_code,wind_speed_10m&hourly=uv_index,precipitation_probability,precipitation&daily=uv_index_max&air_quality=us_aqi&timezone=Asia%2FHo_Chi_Minh`);
                    const marineRes = await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${TIDE_STATION_COORDS.lat}&longitude=${TIDE_STATION_COORDS.lng}&daily=tide_high,tide_low&timezone=Asia%2FHo_Chi_Minh`);
                    const aqiRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lng}&current=us_aqi&timezone=Asia%2FHo_Chi_Minh`);

                    if (!weatherRes.ok) throw new Error("Weather service unavailable");
                    const weatherData = await weatherRes.json();
                    const marineData = await marineRes.ok ? await marineRes.json() : null;
                    const aqiData = await aqiRes.ok ? await aqiRes.json() : null;

                    const current = weatherData.current;
                    const hourly = weatherData.hourly;
                    const aqi = aqiData?.current?.us_aqi || 50;
                    const curHour = new Date().getHours();
                    
                    // Tides
                    let tideData = [];
                    if (marineData?.daily) {
                        const shiftTime = (iso) => {
                            const d = new Date(iso); d.setHours(d.getHours() + 4);
                            return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        };
                        marineData.daily.tide_high.slice(0,2).forEach(t => tideData.push({ type: 'High', time: shiftTime(t), height: '3.5m' }));
                        marineData.daily.tide_low.slice(0,2).forEach(t => tideData.push({ type: 'Low', time: shiftTime(t), height: '1.1m' }));
                        tideData.sort((a, b) => new Date('1970/01/01 ' + a.time) - new Date('1970/01/01 ' + b.time));
                    } else {
                        // Fallback
                        tideData = [
                            { type: 'High', time: '04:30 AM', height: '3.4m' },
                            { type: 'Low', time: '10:15 AM', height: '1.1m' },
                            { type: 'High', time: '05:45 PM', height: '3.9m' },
                            { type: 'Low', time: '11:30 PM', height: '0.8m' }
                        ];
                    }

                    // Risk Logic
                    const rain = current.rain;
                    let risk = "Low", score = 0;
                    if (rain > 5) score += 10;
                    if (rain > 30) score += 50;
                    if (score > 50) risk = "High"; else if (score > 20) risk = "Moderate";

                    setData({
                        location: formattedAddress,
                        coords: { lat, lng },
                        weather: {
                            temp: current.temperature_2m, feelsLike: current.apparent_temperature,
                            humidity: current.relative_humidity_2m, rain: rain,
                            nextHourProb: hourly.precipitation_probability[curHour+1],
                            nextHourAmount: hourly.precipitation[curHour+1],
                            uv: hourly.uv_index[curHour], aqi: aqi, code: current.weather_code
                        },
                        tides: tideData,
                        flood: { level: risk, score: score, canalLevel: 1.2 },
                        news: [
                            { source: 'Official Traffic Map', type: 'traffic-button', url: 'https://giaothong.hochiminhcity.gov.vn/' },
                            ...(rain > 10 ? [{ source: 'Hydro-Met', time: 'Alert', text: 'Heavy rain.', type: 'warning', url: 'https://nchmf.gov.vn/' }] : [])
                        ]
                    });

                    // Update Map
                    if (mapInstance) {
                        mapInstance.setView([lat, lng], 14);
                        if (markerRef.current) mapInstance.removeLayer(markerRef.current);
                        if (circleRef.current) mapInstance.removeLayer(circleRef.current);
                        markerRef.current = window.L.marker([lat, lng]).addTo(mapInstance).bindPopup(formattedAddress).openPopup();
                        circleRef.current = window.L.circle([lat, lng], { color: '#65a30d', fillColor: '#65a30d', fillOpacity: 0.1, radius: 5000 }).addTo(mapInstance);
                    }

                } catch (e) { setError(e.message); } finally { setLoading(false); }
            };

            const handleGetLocation = () => {
                if (!navigator.geolocation) { setError("No Geolocation"); return; }
                setLoading(true);
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        const { latitude: lat, longitude: lng } = pos.coords;
                        if (lat < HCMC_BOUNDS[0][0] || lat > HCMC_BOUNDS[1][0] || lng < HCMC_BOUNDS[0][1] || lng > HCMC_BOUNDS[1][1]) {
                            setError("Outside HCMC"); setLoading(false); return;
                        }
                        try {
                            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
                            const d = await res.json();
                            await fetchEnvironmentalData(lat, lng, formatAddress(d.address));
                        } catch (e) { setError("Failed to fetch data"); setLoading(false); }
                    },
                    () => { setError("Location access denied"); setLoading(false); }
                );
            };

            return (
                <div className={`min-h-screen font-sans flex flex-col transition-colors duration-300 ${theme.bg} ${theme.textMain}`}>
                    <header className={`${theme.cardBg} shadow-sm border-b ${theme.cardBorder} px-4 py-3 flex items-center justify-between z-20 sticky top-0`}>
                        <div className="flex items-center gap-2">
                            <div className={`${isDarkMode ? 'bg-blue-600' : 'bg-lime-700'} p-2 rounded-lg text-white shadow-lg`}><Icon name="map-pin" size={18}/></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">Stay Dry</h1>
                                <div className={`flex items-center gap-1 text-[10px] ${theme.accentPrimary} font-medium uppercase`}><div className={`w-1.5 h-1.5 rounded-full ${isDarkMode ? 'bg-blue-400' : 'bg-lime-500'} animate-pulse`}></div>Ho Chi Minh City</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <a href="https://paypal.me/sivarajpragasm" target="_blank" className="flex items-center gap-1 px-3 py-1.5 rounded-full bg-[#0070BA] text-white text-[10px] font-bold hover:bg-[#003087]"><Icon name="heart" size={12} className="fill-white"/> Donate</a>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-1.5 rounded-full border ${theme.cardBorder} hover:${theme.bg}`}>{isDarkMode ? <Icon name="sun" size={16}/> : <Icon name="moon" size={16}/>}</button>
                        </div>
                    </header>

                    <main className="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full gap-6 grid grid-cols-1 lg:grid-cols-3 h-auto">
                        <div className="lg:col-span-1 flex flex-col gap-4">
                            <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder} relative z-30`}>
                                <div className="flex items-center gap-2 mb-3 text-xs font-semibold text-stone-500">
                                    <Icon name="calendar" size={14} className={theme.accentPrimary} /><span>{currentTime || "Loading..."}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleGetLocation} disabled={loading} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-bold text-white text-sm ${theme.buttonPrimary} shadow-sm active:scale-95`}>
                                        {loading ? "Loading..." : <><Icon name="navigation" size={16} /> Use My Location</>}
                                    </button>
                                    <button onClick={() => setIsPinMode(!isPinMode)} className={`w-14 flex items-center justify-center rounded-lg border transition-all ${isPinMode ? theme.highlight : theme.buttonSecondary}`}><Icon name="crosshair" size={20} /></button>
                                </div>
                                {isPinMode && <div className={`mt-3 text-xs px-3 py-2 rounded border animate-pulse ${theme.highlight}`}>Tap map to select.</div>}
                                {error && <div className="mt-3 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100">{error}</div>}
                            </div>

                            {!data && !loading && <div className={`flex-1 flex flex-col items-center justify-center ${theme.textSub} ${theme.inputBg} rounded-xl border-2 border-dashed ${theme.cardBorder} p-8 min-h-[200px]`}><Icon name="map-pin" size={48} className="mb-4 opacity-20" /><p className="text-center text-sm">Use GPS or Pin to check Rain & Tides.</p></div>}

                            {data && (
                                <>
                                    <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder}`}><h2 className="text-lg font-bold leading-tight">{data.location}</h2></div>
                                    
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder} flex flex-col justify-between`}>
                                            <div className="flex justify-between items-start"><span className={`text-xs font-medium ${theme.textSub}`}>TEMP</span><Icon name="activity" size={24} className={theme.accentPrimary}/></div>
                                            <div className={`text-2xl font-bold ${getStatusColor(data.weather.temp, 'temp')}`}>{data.weather.temp}°C</div>
                                            <div className={`text-xs ${theme.textSub}`}>Feels {data.weather.feelsLike}°</div>
                                        </div>
                                        <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder} flex flex-col justify-between`}>
                                            <div className="flex justify-between items-start"><span className={`text-xs font-medium ${theme.textSub}`}>HUMIDITY</span><Icon name="droplets" size={24} className={theme.accentPrimary}/></div>
                                            <div className={`text-2xl font-bold ${getStatusColor(data.weather.humidity, 'humidity')}`}>{data.weather.humidity}%</div>
                                        </div>
                                    </div>

                                    <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder}`}>
                                        <div className="flex items-center justify-between mb-3"><div className="flex items-center gap-2"><Icon name="cloud-rain" size={18} className={theme.accentPrimary}/><span className="font-semibold">Rain Status</span></div><span className={`text-xs font-bold ${getStatusColor(data.weather.rain, 'rain')}`}>{data.weather.rain > 0 ? 'RAINING' : 'DRY'}</span></div>
                                        <div className="flex items-end gap-2 mb-2"><span className={`text-3xl font-bold ${getStatusColor(data.weather.rain, 'rain')}`}>{data.weather.rain}</span><span className={`text-sm ${theme.textSub} mb-1`}>mm current</span></div>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <div className={`p-2 rounded border ${theme.inputBorder} ${theme.inputBg}`}><div className={theme.textSub}>Next Hour</div><div className={`font-bold ${data.weather.nextHourProb > 50 ? 'text-orange-500' : 'text-lime-600'}`}>{data.weather.nextHourProb}% Chance</div></div>
                                            <div className={`p-2 rounded border ${theme.inputBorder} ${theme.inputBg}`}><div className={theme.textSub}>Exp. Volume</div><div className="font-bold">{data.weather.nextHourAmount} mm</div></div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder}`}>
                                            <div className="flex justify-between items-start"><span className={`text-xs font-medium ${theme.textSub}`}>UV INDEX</span><Icon name="sun" size={20} className={getStatusColor(data.weather.uv, 'uv')}/></div>
                                            <div className={`text-2xl font-bold ${getStatusColor(data.weather.uv, 'uv')}`}>{data.weather.uv.toFixed(1)}</div>
                                            <div className="text-[10px] text-slate-400">{data.weather.uv > 7 ? 'High' : 'Low'}</div>
                                        </div>
                                        <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder}`}>
                                            <div className="flex justify-between items-start"><span className={`text-xs font-medium ${theme.textSub}`}>AIR (AQI)</span><Icon name="wind" size={20} className={getStatusColor(data.weather.aqi, 'aqi')}/></div>
                                            <div className={`text-2xl font-bold ${getStatusColor(data.weather.aqi, 'aqi')}`}>{data.weather.aqi}</div>
                                            <div className="text-[10px] text-slate-400">US Standard</div>
                                        </div>
                                    </div>

                                    <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder}`}>
                                        <div className="flex gap-2 mb-3"><Icon name="newspaper" size={18} className="text-pink-500"/><span className="font-semibold">Official Updates</span></div>
                                        {data.news.map((item, i) => item.type === 'traffic-button' ? (
                                            <a key={i} href={item.url} target="_blank" className={`flex items-center justify-center gap-2 w-full p-3 rounded-lg font-bold text-white text-sm ${theme.buttonPrimary} mb-3 transition-colors shadow-sm`}><Icon name="video" size={16} /> Live Traffic Cameras</a>
                                        ) : (
                                            <a key={i} href={item.url} target="_blank" className={`block p-3 rounded border text-xs hover:opacity-75 ${item.type === 'alert' ? 'bg-red-50 border-red-100' : `${theme.inputBg} ${theme.inputBorder}`}`}><div className="flex justify-between mb-1"><span className={`font-bold flex items-center ${item.type === 'alert' ? 'text-red-600' : theme.textSub}`}>{item.source}</span><span className={theme.textSub}>{item.time}</span></div><p>{item.text}</p></a>
                                        ))}
                                    </div>

                                    <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm border ${theme.cardBorder}`}>
                                        <div className="flex gap-2 mb-3"><Icon name="waves" size={18} className={theme.accentPrimary}/><span className="font-semibold">Tides (Saigon River)</span></div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="flex flex-col gap-2">
                                                <div className={`text-xs font-bold text-center ${theme.textSub} pb-1 border-b ${theme.cardBorder}`}>LOW</div>
                                                {data.tides.filter(t => t.type === 'Low').map((t, i) => (<div key={i} className={`${theme.inputBg} p-2 rounded text-center border ${theme.inputBorder}`}><div className="font-bold text-sm">{t.time}</div><div className={`text-xs font-bold ${getStatusColor(t.height.replace('m',''), 'tide')}`}>{t.height}</div></div>))}
                                            </div>
                                            <div className="flex flex-col gap-2">
                                                <div className={`text-xs font-bold text-center ${theme.accentPrimary} pb-1 border-b ${theme.cardBorder}`}>HIGH</div>
                                                {data.tides.filter(t => t.type === 'High').map((t, i) => (<div key={i} className={`${theme.inputBg} p-2 rounded text-center border ${theme.inputBorder}`}><div className="font-bold text-sm">{t.time}</div><div className={`text-xs font-bold ${getStatusColor(t.height.replace('m',''), 'tide')}`}>{t.height}</div></div>))}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className={`lg:col-span-2 rounded-xl shadow-inner border ${theme.cardBorder} relative overflow-hidden`}>
                            <div id="map" ref={mapRef} style={{ minHeight: '500px', width: '100%', height: '100%' }} />
                            <div className={`absolute bottom-4 right-4 ${isDarkMode ? 'bg-slate-900/90' : 'bg-white/90'} backdrop-blur p-3 rounded-lg shadow-lg text-xs z-[400] border ${theme.cardBorder}`}>
                                <h4 className="font-bold mb-2">Legend</h4>
                                <div className="flex items-center gap-2 mb-1"><div className="w-3 h-3 rounded-full bg-red-500 border-2 border-white shadow-sm"></div><span className={theme.textSub}>Your Location</span></div>
                                <div className="flex items-center gap-2 mb-1"><div className="w-3 h-3 rounded-full bg-red-500 opacity-50"></div><span className={theme.textSub}>Known Flood Zone</span></div>
                                <div className="flex items-center gap-2"><div className={`w-3 h-3 rounded-full ${isDarkMode ? 'bg-blue-500' : 'bg-lime-600'} opacity-20 border`}></div><span className={theme.textSub}>5km Radius</span></div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
